<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AIoT-Explorer | Glove Dashboard</title>

    <!-- Bootstrap 5 -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
      crossorigin="anonymous"
    />

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <style>
      html, body { height: 100%; }
      body {
        background: url("../img/fundal2.png") no-repeat center center fixed;
        background-size: cover;
      }
      .content-wrapper { min-height: 100vh; padding-bottom: 84px; box-sizing: border-box; }
      .main-content { padding: 16px; max-width: 1200px; margin: 0 auto; }

      .card { border-radius: 16px; box-shadow: 0 6px 16px rgba(0,0,0,.08); }
      .metric { font-variant-numeric: tabular-nums; }

      /* Characters area */
      .char-stream {
        min-height: 88px;
        max-height: 160px;
        overflow-y: auto;
        white-space: pre-wrap;
        border-radius: 10px;
        background: rgba(255,255,255,.75);
        padding: 10px 12px;
      }
      .big-char {
        font-size: clamp(56px, 8vw, 92px);
        line-height: 1;
        font-weight: 800;
        letter-spacing: .03em;
      }
      .status-dot { width:10px; height:10px; border-radius:50%; display:inline-block; margin-right:8px; }
      .status-ok { background:#22c55e; }
      .status-warn { background:#f59e0b; }
      .status-bad { background:#ef4444; }

      footer.sticky-footer { position: fixed; bottom: 0; left: 0; right: 0; z-index: 1030; }
    </style>
  </head>
  <body>
    <!-- Header / Navbar -->
    <nav class="navbar navbar-expand-md" style="background: linear-gradient(to right, #fff, rgb(59, 177, 177));">
      <div class="container">
        <a class="navbar-brand" href="Echipa1.html">
          <img src="/img/IoT - Team B.png" height="60" alt="AIoT Explorer"/>
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="nav">
          <ul class="navbar-nav me-auto">
            <li class="nav-item"><a class="nav-link active" href="index.html">Home</a></li>
            <li class="nav-item"><a class="nav-link" href="Meet_the_Team.html">Meet the Team</a></li>
            <li class="nav-item"><a class="nav-link" href="Our_project.html">Our Project</a></li>
            <li class="nav-item"><a class="nav-link" href="Dashboard_proiect.html">Dashboard Project</a></li>
            <li class="nav-item"><a class="nav-link" href="Contact_us.html">Contact Us</a></li>
            <li class="nav-item"><a class="nav-link" href="news.html">News & Updates</a></li>
          </ul>
          <form class="d-flex"><input class="form-control me-2" placeholder="Search"/><button class="btn btn-outline-success" style="background:#00796b;color:#e0f7fa;">Search</button></form>
        </div>
      </div>
    </nav>

    <!-- Main -->
    <main>
      <div class="content-wrapper">
        <div class="main-content">

          <!-- Top controls + status -->
          <div class="row g-3 align-items-stretch mb-3">
            <div class="col-lg-8">
              <div class="card h-100">
                <div class="card-body d-flex flex-wrap gap-2 align-items-center">
                  <div class="me-auto">
                    <div class="fw-semibold">Glove status</div>
                    <div class="small text-muted">Stream flex sensors (5) + IMU</div>
                  </div>
                  <div id="connStatus" class="badge text-bg-success px-3 py-2">
                    <span class="status-dot status-ok"></span>Connected (demo)
                  </div>
                  <div class="btn-group">
                    <button id="btnConnect" class="btn btn-outline-primary">Connect</button>
                    <button id="btnPause" class="btn btn-outline-secondary">Pause</button>
                    <button id="btnClear" class="btn btn-outline-danger">Clear</button>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-lg-4">
              <div class="card h-100">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <div class="fw-semibold">Recognition latency</div>
                      <div class="small text-muted">last pipeline cycle</div>
                    </div>
                    <div class="display-6 metric" id="latencyMs">— ms</div>
                  </div>
                  <div class="progress mt-2" role="progressbar" aria-label="Confidence" aria-valuemin="0" aria-valuemax="100">
                    <div id="confBar" class="progress-bar" style="width: 0%">0%</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Charts -->
          <div class="row g-3">
            <div class="col-lg-7">
              <div class="card">
                <div class="card-header bg-white">
                  <strong>Flex sensors – real‑time</strong>
                  <span class="text-muted small">(Finger 1..5, 0–100%)</span>
                </div>
                <div class="card-body"><canvas id="flexRealtime"></canvas></div>
              </div>
            </div>

            <div class="col-lg-5">
              <div class="card">
                <div class="card-header bg-white">
                  <strong>Flex snapshot – current</strong>
                  <span class="text-muted small">(bars update each tick)</span>
                </div>
                <div class="card-body"><canvas id="flexBars"></canvas></div>
              </div>
            </div>
          </div>

          <!-- Characters / Output area -->
          <div class="row g-3 mt-1">
            <div class="col-lg-8">
              <div class="card">
                <div class="card-header bg-white d-flex align-items-center justify-content-between">
                  <strong>Recognized text</strong>
                  <div class="btn-group btn-group-sm">
                    <button id="btnBackspace" class="btn btn-outline-secondary" title="Backspace">⌫</button>
                    <button id="btnSpace" class="btn btn-outline-secondary" title="Space">⎵</button>
                    <button id="btnCopy" class="btn btn-outline-secondary" title="Copy">Copy</button>
                  </div>
                </div>
                <div class="card-body">
                  <div class="char-stream" id="textStream" aria-live="polite"></div>
                </div>
              </div>
            </div>
            <div class="col-lg-4">
              <div class="card text-center">
                <div class="card-header bg-white"><strong>Last character</strong></div>
                <div class="card-body">
                  <div id="bigChar" class="big-char">—</div>
                  <div class="small text-muted">confidence <span id="confPct">0%</span></div>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer class="sticky-footer" style="background-color: rgb(59, 177, 177); color:#e0f7fa; text-align:center; padding:10px;">
      <p class="mb-0">© 2025 AIoT-Explorer - part of the unified, multi-tenant IoT platform developed in the frame of 2025 IoT Explorer Program</p>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js" crossorigin="anonymous"></script>

    <!-- Dashboard Logic -->
    <script>
      /**
       * DATA CONTRACT (plug your glove here)
       * Send frames as JSON strings via WebSocket or Web Serial and call handleFrame(data):
       * {
       *   t: Number (ms timestamp),
       *   flex: [f1,f2,f3,f4,f5] values from 0..100 (percent flexion),
       *   imu: { ax, ay, az, gx, gy, gz }, // optional
       *   char: { value: 'A', confidence: 0..1, latencyMs: 0..200 }
       * }
       */

      // ---------- Chart helpers ----------
      const MAX_POINTS = 120; // ~ last 24s at 200ms
      const fingerNames = ["Thumb","Index","Middle","Ring","Pinky"];

      const ctxRealtime = document.getElementById('flexRealtime').getContext('2d');
      const ctxBars = document.getElementById('flexBars').getContext('2d');

      const palette = [
        'rgba(13,110,253,0.9)',
        'rgba(25,135,84,0.9)',
        'rgba(255,193,7,0.9)',
        'rgba(220,53,69,0.9)',
        'rgba(32,201,151,0.9)'
      ];

      // Line datasets per finger
      const lineDatasets = fingerNames.map((name, i) => ({
        label: name,
        data: [],
        borderColor: palette[i],
        backgroundColor: palette[i],
        borderWidth: 2,
        pointRadius: 0,
        tension: .2
      }));

      const lineChart = new Chart(ctxRealtime, {
        type: 'line',
        data: { labels: [], datasets: lineDatasets },
        options: {
          animation: false,
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { ticks: { display: false } },
            y: { min: 0, max: 100, title: { display: true, text: 'Flex %' } }
          },
          plugins: {
            legend: { position: 'bottom' },
            tooltip: { mode: 'nearest', intersect: false }
          }
        }
      });

      const barChart = new Chart(ctxBars, {
        type: 'bar',
        data: {
          labels: fingerNames,
          datasets: [{
            label: 'Current flex %',
            data: [0,0,0,0,0]
          }]
        },
        options: {
          animation: { duration: 0 },
          responsive: true,
          maintainAspectRatio: false,
          scales: { y: { min:0, max:100 } },
          plugins: { legend: { display:false } }
        }
      });

      function pushFlex(values) {
        const now = new Date();
        lineChart.data.labels.push(now.toLocaleTimeString());
        lineChart.data.labels.length > MAX_POINTS && lineChart.data.labels.shift();
        values.forEach((v, i) => {
          lineChart.data.datasets[i].data.push(v);
          if (lineChart.data.datasets[i].data.length > MAX_POINTS) {
            lineChart.data.datasets[i].data.shift();
          }
        });
        lineChart.update('none');

        // bars
        barChart.data.datasets[0].data = values;
        barChart.update('none');
      }

      // ---------- Characters area ----------
      const bigChar = document.getElementById('bigChar');
      const textStream = document.getElementById('textStream');
      const confBar = document.getElementById('confBar');
      const confPct = document.getElementById('confPct');
      const latencyMs = document.getElementById('latencyMs');

      function updateRecognition(char, confidence, latency) {
        bigChar.textContent = char || '—';
        const pct = Math.round((confidence || 0) * 100);
        confBar.style.width = pct + '%';
        confBar.textContent = pct + '%';
        confPct.textContent = pct + '%';
        latencyMs.textContent = (latency ?? 0) + ' ms';

        if (char) {
          // Debounce repeated characters if confidence low
          const last = textStream.dataset.lastChar || '';
          if (!(char === last && pct < 70)) {
            textStream.textContent += char;
            textStream.dataset.lastChar = char;
            textStream.scrollTop = textStream.scrollHeight;
          }
        }
      }

      // Controls
      document.getElementById('btnBackspace').addEventListener('click', () => {
        textStream.textContent = textStream.textContent.slice(0, -1);
      });
      document.getElementById('btnSpace').addEventListener('click', () => {
        textStream.textContent += ' ';
      });
      document.getElementById('btnCopy').addEventListener('click', async () => {
        await navigator.clipboard.writeText(textStream.textContent);
      });

      // ---------- Demo data generator (remove when wiring to device) ----------
      let paused = false;
      let demoInterval = null;

      function randWalk(prev, speed = 8) {
        // keep between 0..100 with a gentle random walk
        return Math.max(0, Math.min(100, prev + (Math.random() - 0.48) * speed));
      }

      let flexState = [12, 18, 24, 30, 20];
      const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');

      function startDemo() {
        stopDemo();
        demoInterval = setInterval(() => {
          if (paused) return;
          flexState = flexState.map((v, i) => randWalk(v, 10 - i));
          pushFlex(flexState.map(v => Math.round(v)));

          // fake recognition occasionally
          if (Math.random() < 0.35) {
            const ch = alphabet[Math.floor(Math.random()*alphabet.length)];
            const confidence = Math.random()*0.5 + 0.5; // 50..100%
            const latency = Math.floor(30 + Math.random()*60);
            updateRecognition(ch, confidence, latency);
          } else {
            updateRecognition(null, 0, null);
          }
        }, 200);
      }
      function stopDemo(){ if (demoInterval) clearInterval(demoInterval); }

      // ---------- Hook up top buttons ----------
      const btnConnect = document.getElementById('btnConnect');
      const btnPause   = document.getElementById('btnPause');
      const btnClear   = document.getElementById('btnClear');
      const connStatus = document.getElementById('connStatus');

      btnConnect.addEventListener('click', async () => {
        // Replace this with Web Serial / WebSocket connect as needed
        // Example skeletons below.
        if (btnConnect.dataset.mode !== 'demo') {
          btnConnect.dataset.mode = 'demo';
          connStatus.className = 'badge text-bg-success px-3 py-2';
          connStatus.innerHTML = '<span class="status-dot status-ok"></span>Connected (demo)';
          startDemo();
        } else {
          btnConnect.dataset.mode = '';
          connStatus.className = 'badge text-bg-secondary px-3 py-2';
          connStatus.innerHTML = '<span class="status-dot status-warn"></span>Disconnected';
          stopDemo();
        }
      });

      btnPause.addEventListener('click', () => {
        paused = !paused;
        btnPause.textContent = paused ? 'Resume' : 'Pause';
      });

      btnClear.addEventListener('click', () => {
        // clear charts & text
        lineChart.data.labels = [];
        lineChart.data.datasets.forEach(d => d.data = []);
        lineChart.update();
        barChart.data.datasets[0].data = [0,0,0,0,0];
        barChart.update();
        textStream.textContent = '';
        bigChar.textContent = '—';
        updateRecognition(null, 0, null);
      });

      // Auto-start demo so the page feels alive
      startDemo();

      // ---------- OPTIONAL: WebSocket wiring example ----------
      // function connectWS(url) {
      //   const ws = new WebSocket(url);
      //   ws.onopen = () => { connStatus.className = 'badge text-bg-success px-3 py-2'; connStatus.innerHTML = '<span class="status-dot status-ok"></span>Connected (WS)'; };
      //   ws.onclose = () => { connStatus.className = 'badge text-bg-secondary px-3 py-2'; connStatus.innerHTML = '<span class="status-dot status-warn"></span>Disconnected'; };
      //   ws.onmessage = (evt) => { handleFrame(JSON.parse(evt.data)); };
      // }

      // ---------- OPTIONAL: Web Serial wiring example ----------
      // async function connectSerial() {
      //   const port = await navigator.serial.requestPort();
      //   await port.open({ baudRate: 115200 });
      //   connStatus.className = 'badge text-bg-success px-3 py-2';
      //   connStatus.innerHTML = '<span class="status-dot status-ok"></span>Connected (Serial)';
      //   const decoder = new TextDecoderStream();
      //   const inputDone = port.readable.pipeTo(decoder.writable);
      //   const inputStream = decoder.readable;
      //   const reader = inputStream.getReader();
      //   let buf = '';
      //   while (true) {
      //     const { value, done } = await reader.read();
      //     if (done) break;
      //     buf += value;
      //     let idx;
      //     while ((idx = buf.indexOf('\n')) >= 0) {
      //       const line = buf.slice(0, idx).trim();
      //       buf = buf.slice(idx + 1);
      //       if (line) handleFrame(JSON.parse(line));
      //     }
      //   }
      // }

      // Core frame handler
      function handleFrame(frame) {
        if (!frame) return;
        if (Array.isArray(frame.flex)) {
          const vals = frame.flex.map(v => Math.max(0, Math.min(100, Number(v))));
          pushFlex(vals);
        }
        if (frame.char && frame.char.value) {
          updateRecognition(frame.char.value, frame.char.confidence ?? 0, frame.char.latencyMs ?? 0);
        }
      }
    </script>
  </body>
</html>